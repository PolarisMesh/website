---
title: "服务限流"
linkTitle: "服务限流"
weight: 325
---

### 单机服务限流


##### 项目初始化

使用 jetbrain idea 等工具初始化一个 Spring Cloud 项目

##### 引入依赖

在上一步初始化好一个 maven 项目之后，我们在 pom.xml 中引入 Spring Cloud Tencent 相关依赖。

- 引入 **spring-cloud-tencent-dependencies** 进行管理 Spring Cloud Tencent 相关组件的依赖版本。
- 引入 **spring-cloud-starter-tencent-polaris-discovery** 实现通过 Feign 或者 RestTemplate 完成服务调用。


```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.6.11</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    ...

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.tencent.cloud</groupId>
                <artifactId>spring-cloud-tencent-dependencies</artifactId>
                <version>1.7.0-2021.0.3</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>2021.0.3</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        ...
        <!-- 北极星服务注册发现依赖 -->
        <dependency>
            <groupId>com.tencent.cloud</groupId>
            <artifactId>spring-cloud-starter-tencent-polaris-discovery</artifactId>
        </dependency>
        <!-- 北极星服务限流依赖 -->
        <dependency>
            <groupId>com.tencent.cloud</groupId>
            <artifactId>spring-cloud-starter-tencent-polaris-ratelimit</artifactId>
        </dependency>
        ...
    </dependencies>
    ...

</project>
```

##### 配置 application.yml 

在 resources 目录下创建 application.yml 文件，并按照如下进行配置

```
.
├── java
│   └── com
│       └── example
│           └── spingcloudpolarisratelimit
│               └── SpringCloudRateLimitApplication.java
└── resources
    └── application.yaml
```

配置 application.yml

```yaml
server:
  port: 38888
spring:
  application:
    name: RateLimitEchoServer

  cloud:
    polaris:
      namespace: default # 设置注册中心命名空间
      address: grpc://127.0.0.1:8091
      discovery:
        enabled: true
      stat:
        enabled: true
        port: 38082
```

##### 示例代码

```java
@SpringBootApplication
public class SpringCloudRateLimitApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringCloudRateLimitApplication.class, args);
    }

    @RestController
    static class EchoController {

        @GetMapping(value = "/echo")
        public String echo() {
            return "Hello PolarisMesh , I'm RateLimit Demo";
        }
    }
}
```

##### 配置限流规则

为服务 `EchoServer` 创建一条限流规则

![](../图片/springcloud%E6%8E%A5%E5%85%A5/springcloud接入-创建限流规则.png)

##### 验证

通过 curl 命令快速发起多次查询，查看是否触发限流

```bash
curl --location --request GET '127.0.0.1:38888/echo'
```

预期的结果如下

```
➜  curl --location --request GET '127.0.0.1:38888/echo'
Hello PolarisMesh , I'm RateLimit Demo%
➜  curl --location --request GET '127.0.0.1:38888/echo'
The request is denied by rate limit because the throttling threshold is reached%
➜  curl --location --request GET '127.0.0.1:38888/echo'
Hello PolarisMesh , I'm RateLimit Demo%
```


### 分布式服务限流

##### 安装北极星分布式限流服务端

具体操作参见 [Polaris 分布式限流服务端安装](./%E5%AE%89%E8%A3%85%E6%9C%8D%E5%8A%A1%E7%AB%AF/%E5%AE%89%E8%A3%85%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81%E6%9C%8D%E5%8A%A1.md)

##### 项目初始化

使用 jetbrain idea 等工具初始化一个 Spring Cloud 项目

##### 引入依赖

在上一步初始化好一个 maven 项目之后，我们在 pom.xml 中引入 Spring Cloud Tencent 相关依赖。

- 引入 **spring-cloud-tencent-dependencies** 进行管理 Spring Cloud Tencent 相关组件的依赖版本。
- 引入 **spring-cloud-starter-tencent-polaris-discovery** 实现通过 Feign 或者 RestTemplate 完成服务调用。


```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.6.11</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    ...

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.tencent.cloud</groupId>
                <artifactId>spring-cloud-tencent-dependencies</artifactId>
                <version>1.7.0-2021.0.3</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>2021.0.3</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        ...
        <!-- 北极星服务注册发现依赖 -->
        <dependency>
            <groupId>com.tencent.cloud</groupId>
            <artifactId>spring-cloud-starter-tencent-polaris-discovery</artifactId>
        </dependency>
        <!-- 北极星服务限流依赖 -->
        <dependency>
            <groupId>com.tencent.cloud</groupId>
            <artifactId>spring-cloud-starter-tencent-polaris-ratelimit</artifactId>
        </dependency>
        ...
    </dependencies>
    ...

</project>
```

##### 配置 application.yml 

在 resources 目录下创建 application.yml 文件 文件以及 polaris.yml，并按照如下进行配置

```
.
├── java
│   └── com
│       └── example
│           └── spingcloudpolarisratelimit
│               └── SpringCloudRateLimitApplication.java
└── resources
    ├── polaris.yml
    └── application.yaml
```

配置 application.yml

```yaml
server:
  port: 38888
spring:
  application:
    name: RateLimitEchoServer

  cloud:
    polaris: 
      namespace: default # 设置注册中心命名空间
      address: grpc://127.0.0.1:8091
      discovery:
        enabled: true
      stat:
        enabled: true
        port: 38082
```

配置 polaris.yml

```yaml
# 被调方配置
provider:
  rateLimit:
    # 是否开启限流功能
    enable: true
    # 限流服务的命名空间
    limiterNamespace: Polaris
    # 限流服务名
    limiterService: polaris.limiter
```

##### 示例代码

```java
@SpringBootApplication
public class SpringCloudRateLimitApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringCloudRateLimitApplication.class, args);
    }

    @RestController
    static class EchoController {

        @GetMapping(value = "/echo")
        public String echo() {
            return "Hello PolarisMesh , I'm RateLimit Demo";
        }
    }
}
```

##### 配置限流规则

为服务 `EchoServer` 创建一条限流规则

![](../图片/springcloud%E6%8E%A5%E5%85%A5/springcloud接入-创建分布式限流规则.png)

##### 验证

通过 curl 命令快速发起多次查询，查看是否触发限流

```bash
curl --location --request GET '127.0.0.1:38888/echo'
```

预期的结果如下

```
➜  curl --location --request GET '127.0.0.1:38888/echo'
Hello PolarisMesh , I'm RateLimit Demo%
➜  curl --location --request GET '127.0.0.1:38888/echo'
The request is denied by rate limit because the throttling threshold is reached%
➜  curl --location --request GET '127.0.0.1:38888/echo'
Hello PolarisMesh , I'm RateLimit Demo%
```
